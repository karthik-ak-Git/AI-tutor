name: CI/CD Pipeline

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]

jobs:
  # ============================================
  # JOB 1: Code Quality & Testing
  # ============================================
  lint-and-test:
    name: Code Quality & Testing
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: üì• Checkout code
        uses: actions/checkout@v4

      - name: üêç Set up Python 3.11
        uses: actions/setup-python@v4
        with:
          python-version: "3.11"
          cache: "pip"

      - name: üì¶ Install production dependencies
        run: |
          python -m pip install --upgrade pip setuptools wheel
          pip install -r requirements.txt

      - name: üì¶ Install development dependencies
        run: |
          pip install -r requirements-dev.txt

      # ============================================
      # CHECK 1: Syntax & Critical Errors (flake8)
      # ============================================
      - name: üîç Lint - Critical Errors (flake8)
        run: |
          echo "Checking for syntax errors and undefined names..."
          flake8 app/ \
            --select=E9,F63,F7,F82 \
            --show-source \
            --statistics \
            --config=.flake8
        # FAILS CI on critical errors

      # ============================================
      # CHECK 2: Code Style (flake8)
      # ============================================
      - name: üé® Lint - Code Style (flake8)
        continue-on-error: true
        run: |
          echo "Checking code style (non-blocking)..."
          flake8 app/ \
            --count \
            --exit-zero \
            --max-complexity=10 \
            --max-line-length=127 \
            --statistics \
            --config=.flake8 || echo "‚ö†Ô∏è Style issues found (non-blocking)"
        # WARNING only, doesn't fail CI

      # ============================================
      # CHECK 3: Code Formatting (black)
      # ============================================
      - name: üé® Format Check (black)
        run: |
          echo "Checking code formatting..."
          black --check app/ --config pyproject.toml
        # FAILS CI if formatting issues found

      # ============================================
      # CHECK 4: Type Checking (mypy)
      # ============================================
      - name: üîé Type Check (mypy)
        continue-on-error: true
        run: |
          echo "Running type checking..."
          mypy app/ --config-file mypy.ini || echo "‚ö†Ô∏è Type issues found (non-blocking)"
        # WARNING only, doesn't fail CI

      # ============================================
      # CHECK 5: Import Sorting (isort)
      # ============================================
      - name: üìã Import Sort Check (isort)
        continue-on-error: true
        run: |
          echo "Checking import order..."
          isort --check-only app/ --profile black || echo "‚ö†Ô∏è Import order issues (non-blocking)"
        # WARNING only, doesn't fail CI

      # ============================================
      # CHECK 6: Security Scan (bandit)
      # ============================================
      - name: üîí Security Scan (bandit)
        continue-on-error: true
        run: |
          echo "Scanning for security issues..."
          bandit -r app/ -f json -o bandit-report.json || true
          bandit -r app/ -ll || echo "‚ö†Ô∏è Security issues found (non-blocking)"
        # WARNING only, doesn't fail CI

      # ============================================
      # CHECK 7: Unit Tests (pytest)
      # ============================================
      - name: üß™ Run Unit Tests (pytest)
        continue-on-error: true
        run: |
          echo "Running unit tests..."
          pytest tests/ -v --tb=short
        env:
          OPENROUTER_API_KEY: ${{ secrets.OPENROUTER_API_KEY || 'test-key-for-ci' }}
        # WARNING only, doesn't fail CI

      # ============================================
      # CHECK 8: Test Coverage (pytest-cov)
      # ============================================
      - name: üìä Test Coverage (pytest-cov)
        continue-on-error: true
        run: |
          echo "Generating test coverage report..."
          pytest tests/ \
            -v \
            --cov=app \
            --cov-report=xml \
            --cov-report=term-missing \
            --cov-report=html \
            --cov-fail-under=0 || echo "‚ö†Ô∏è Coverage below threshold (non-blocking)"
        env:
          OPENROUTER_API_KEY: ${{ secrets.OPENROUTER_API_KEY || 'test-key-for-ci' }}
        # WARNING only, doesn't fail CI

      # ============================================
      # CHECK 9: Upload Coverage Report
      # ============================================
      - name: üì§ Upload Coverage to Codecov
        if: always()
        uses: codecov/codecov-action@v4
        with:
          file: ./coverage.xml
          flags: unittests
          name: codecov-umbrella
          fail_ci_if_error: false

      # ============================================
      # CHECK 10: Upload Security Report
      # ============================================
      - name: üì§ Upload Security Report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: bandit-security-report
          path: bandit-report.json
          if-no-files-found: ignore

  # ============================================
  # JOB 2: Docker Build & Test
  # ============================================
  docker-build:
    name: Docker Build & Test
    runs-on: ubuntu-latest
    needs: lint-and-test
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    timeout-minutes: 20

    steps:
      - name: üì• Checkout code
        uses: actions/checkout@v4

      - name: üê≥ Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      # ============================================
      # CHECK 11: Docker Build
      # ============================================
      - name: üèóÔ∏è Build Docker Image
        uses: docker/build-push-action@v5
        with:
          context: .
          push: false
          tags: ai-tutor:latest
          cache-from: type=gha
          cache-to: type=gha,mode=max
          platforms: linux/amd64
        # FAILS CI if build fails

      # ============================================
      # CHECK 12: Docker Container Health
      # ============================================
      - name: üè• Test Docker Container
        run: |
          echo "Testing Docker container..."
          docker run --rm -d \
            -p 8000:8000 \
            --name ai-tutor-test \
            -e OPENROUTER_API_KEY=test-key-for-ci \
            ai-tutor:latest
          
          echo "Waiting for container to start..."
          sleep 15
          
          echo "Testing health endpoint..."
          curl -f http://localhost:8000/health || exit 1
          
          echo "Container is healthy!"
          docker stop ai-tutor-test
        # FAILS CI if container doesn't start or health check fails

  # ============================================
  # JOB 3: Dependency Check
  # ============================================
  dependency-check:
    name: Dependency Security Check
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: üì• Checkout code
        uses: actions/checkout@v4

      - name: üêç Set up Python 3.11
        uses: actions/setup-python@v4
        with:
          python-version: "3.11"
          cache: "pip"

      # ============================================
      # CHECK 13: Dependency Vulnerability Scan
      # ============================================
      - name: üîí Check Dependencies (safety)
        continue-on-error: true
        run: |
          echo "Checking for vulnerable dependencies..."
          pip install safety
          safety check --json || echo "‚ö†Ô∏è Vulnerable dependencies found (non-blocking)"
        # WARNING only, doesn't fail CI
